#textdomain wesnoth-A_Vision_Blinded

#define DWARF_AI
        [ai]
            passive_leader=no
            grouping=yes
            recruitment_ignore_bad_combat=yes
            attack_depth="5"
            caution=0
            aggression=1
            [target]
                side=1
                value=10
            [/target]
            [target]
                side=6
                value=0,25
            [/target]
        [/ai]
#enddef

#define BREAKTHROUGH X Y
        [animate_unit]
            [filter]
                id="Kruurg"
            [/filter]
            flag=attack
            hits=yes
            with_bars=yes
            [primary_attack]
                name=hammer
            [/primary_attack]
            [facing]
                [filter]
                    x,y={X},{Y}
                [/filter]
            [/facing]
        [/animate_unit]
        {QUAKE "rumble.ogg"}
        [delay]
            time=200
        [/delay]
        [animate_unit]
            [filter]
                id="Kruurg"
            [/filter]
            flag=attack
            hits=yes
            with_bars=yes
            [primary_attack]
                name=hammer
            [/primary_attack]
            [facing]
                x,y={X},{Y}
            [/facing]
        [/animate_unit]
        {QUAKE "rumble.ogg"}
        [delay]
            time=200
        [/delay]
        [animate_unit]
            [filter]
                id="Kruurg"
            [/filter]
            flag=attack
            hits=yes
            with_bars=yes
            [primary_attack]
                name=hammer
            [/primary_attack]
            [facing]
                x,y={X},{Y}
            [/facing]
        [/animate_unit]
        {QUAKE "rumble.ogg"}
        [terrain]
            x,y={X},{Y}
            terrain=Uu^Dr
        [/terrain]
        [redraw]
            side=1
        [/redraw]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The wall collapses before the might of the troll."
        [/message]
        [redraw]
            side=1
        [/redraw]
        [delay]
            time=300
        [/delay]
#enddef

#define KRUURG_CRUSHES_WALL X Y
        [animate_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            flag=attack
            hits=yes
            with_bars=yes
            [primary_attack]
                name=hammer
            [/primary_attack]
            [facing]
                x,y={X},{Y}
            [/facing]
        [/animate_unit]
        {QUAKE "rumble.ogg"}
        [delay]
            time=200
        [/delay]
        [animate_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            flag=attack
            hits=yes
            with_bars=yes
            [primary_attack]
                name=hammer
            [/primary_attack]
            [facing]
                x,y={X},{Y}
            [/facing]
        [/animate_unit]
        {QUAKE "rumble.ogg"}
        [delay]
            time=200
        [/delay]
        [animate_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            flag=attack
            hits=yes
            with_bars=yes
            [primary_attack]
                name=hammer
            [/primary_attack]
            [facing]
                x,y={X},{Y}
            [/facing]
        [/animate_unit]
        {QUAKE "rumble.ogg"}
        [terrain]
            x,y={X},{Y}
            terrain=Uu^Dr
        [/terrain]
        [redraw]
            side=1
        [/redraw]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The wall collapses before the might of the troll."
        [/message]
        [redraw]
            side=1
        [/redraw]
        [delay]
            time=300
        [/delay]
#enddef

#define FAKE_ATTACK_WITH_DAMAGE ATTACKER DEFENDER ATTACK ATTACK2 M1 M2
        [animate_unit]
            [filter]
                id={ATTACKER}
            [/filter]
            flag=attack
            hits=yes
            with_bars=yes
            [primary_attack]
                name={ATTACK}
            [/primary_attack]
            [facing]
                id={DEFENDER}
            [/facing]
            [animate]
                [filter]
                    id={DEFENDER}
                [/filter]
                flag=defend
                hits=hit
                with_bars=yes
                [primary_attack]
                    name={ATTACK2}
                [/primary_attack]
                [facing]
                    id={ATTACKER}
                [/facing]
            [/animate]
        [/animate_unit]

        [store_unit]
            [filter]
                id={ATTACKER}
            [/filter]
            variable=stored_attacker
        [/store_unit]

        {VARIABLE_OP stored_attacker.hitpoints multiply {M1}}
        {VARIABLE_OP stored_attacker.experience add 2}

        [unstore_unit]
            variable=stored_attacker
            find_vacant=no
        [/unstore_unit]

        [store_unit]
            [filter]
                id={DEFENDER}
            [/filter]
            variable=stored_defender
        [/store_unit]

        {VARIABLE_OP stored_defender.hitpoints multiply {M2}}
        {VARIABLE_OP stored_defender.experience add 1}

        [unstore_unit]
            variable=stored_defender
            find_vacant=no
        [/unstore_unit]

        [redraw]
            side=1
        [/redraw]

        {CLEAR_VARIABLE stored_attacker}
        {CLEAR_VARIABLE stored_defender}
#enddef









[scenario]
    name=_"Emerging from the Depths"
    id="06_Emerging_from_the_Depths"

#ifver WESNOTH_VERSION < 1.11.0
    map_data="{~add-ons/A_Vision_Blinded/maps/maps_10/06_Emerging_from_the_Depths.map}"
#else
    #ifver WESNOTH_VERSION >= 1.11.0
        map_data="{~add-ons/A_Vision_Blinded/maps/maps_11/06_Emerging_from_the_Depths.map}"
    #endif
#endif

    {TURNS 68 65 62}

    {SCENARIO_MUSIC underground.ogg}

    victory_when_enemies_defeated=no
    next_scenario=07_On_the_Marshes

    {UNDERGROUND}

    [side]
        type="Elvish Sorceress"
        id="Quoscelia"
        name= _ "Qouscelia"
        unrenamable=yes
        side="1"
        canrecruit="yes"
        controller="human"
        team_name="goodies"
        fog="no"
        share_view="no"
        shroud="yes"
        share_maps="no"
        user_team_name= _ "Quoscelia"
        recruit="Elvish Archer, Elvish Fighter, Elvish Scout, Elvish Shaman, Troll Whelp"
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_INTELLIGENT}
        [/modifications]
        {GOLD 240 210 180}
    [/side]

    ##|| Enemy
    [side]
#ifdef HARD
        type="Dwarvish Lord"
#else
        type="Dwarvish Steelclad"
#endif
        id="Dwarfleader_1"
        name="Agtrissil"
        side="2"
        canrecruit="yes"
        team_name="baddies"
        controller="ai"
        fog="no"
        share_view="no"
        shroud="no"
        share_maps="no"
        user_team_name= _ "Dwarves"
        recruit="Dwarvish Steelclad, Dwarvish Thunderer"
        {DWARF_AI}
        [ai]
            [avoid]
                x=32-40
                y=40-50
            [/avoid]
        [/ai]
        {GOLD 60 90 100}
    [/side]

    [side]
#ifdef HARD
        type="Dwarvish Dragonguard"
#else
        type="Dwarvish Thunderguard"
#endif
        id="Dwarfleader_2"
        name="Agtressil"
        side="3"
        canrecruit="yes"
        team_name="baddies"
        controller="ai"
        fog="no"
        share_view="no"
        shroud="no"
        share_maps="no"
        user_team_name= _ "Dwarves (enemy)"
        recruit="Dwarvish Fighter, Dwarvish Thunderer, Dwarvish Scout"
        {DWARF_AI}
        [ai]
            [avoid]
                x=32-40
                y=40-50
            [/avoid]
        [/ai]
        {GOLD 55 70 85}
        {INCOME 8 10  12}              # v 1.0.3  raised income +2
    [/side]

    [side]
        type="Dwarvish Runemaster"
        id="Dwarfleader_3"
        name="Agtrussil"
        side="4"
        canrecruit="yes"
        team_name="baddies"
        controller="ai"
        fog="no"
        share_view="no"
        shroud="no"
        share_maps="no"
        user_team_name= _ "Dwarves (enemy)"
        recruit="Dwarvish Fighter, Dwarvish Thunderer"
        {DWARF_AI}
        [ai]
            [avoid]
                x=1-40,32-40
                y=1-17,40-50
            [/avoid]
        [/ai]
        gold="0" ### later when Dwarfleader_2 dies
    [/side]

    [side]
#ifdef HARD
        type="Dwarvish Sentinel"
#else
        type="Dwarvish Stalwart"
#endif
        id="Dwarfleader_4"
        id="Agtrossil"
        side="5"
        canrecruit="yes"
        team_name="baddies"
        controller="ai"
        fog="no"
        share_view="no"
        shroud="no"
        share_maps="no"
        user_team_name= _ "Dwarves (enemy)"
        recruit="Dwarvish Fighter, Dwarvish Thunderer"
        {DWARF_AI}
        [ai]
            [avoid]
                x=1-40,32-40
                y=1-27,40-50
            [/avoid]
        [/ai]
        gold="0" ### later when Dwarfleader_2 dies
    [/side]

    [side]
        type="Blood Bat"
        id="Fierce Bat"
        name="Fierce Bat"
        side="6"
        canrecruit="yes"
        team_name="bats"
        controller="ai"
        fog="no"
        share_view="no"
        shroud="no"
        share_maps="no"
        user_team_name= _ "Fierce Bat (enemy)"
        income=0
#ifdef HARD
        recruit="Blood Bat"
#else
        recruit="Vampire Bat"
#endif
        [ai]
            grouping="offensive"
            attack_depth="5"
            village_value="0"
            aggression=1
            caution=0
            [target]
                side=1
                value=10
            [/target]
            [target]
                side=2,3,4,5
                value=0,25
            [/target]
            ### the bats should stay away from the dwarvish keeps
            [avoid]
                x=5-17,29-55
                y=37-44,55-62
            [/avoid]
        [/ai]
        gold="0" # later when Dwarfleader_1 dies
    [/side]

        ### fake side for prisoners

    [side]
        no_leader=yes
        side="7"
        canrecruit="no"
        gold="0"
        team_name="baddies"
        controller="0"
        hidden=yes
        color=red
        gold=0
        income=-2
    [/side]

        ### the spider

    [side]
        no_leader=yes
        side="8"
        canrecruit="no"
        gold="0"
        team_name="bats,baddies"
        controller="0"
        hidden=yes
        gold=50
        income=8
    [/side]


    {STARTING_VILLAGES 2 5}
    {STARTING_VILLAGES 3 5}

#ifdef EASY
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Dwarvish Steelclad) 1}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Dwarvish Steelclad) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Steelclad) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Steelclad) 4}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Dwarvish Thunderguard) 0}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Dwarvish Thunderguard) 0}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Thunderguard) 1}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Thunderguard) 1}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Stalwart) 1}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Stalwart) 1}
#endif

#ifdef NORMAL
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Dwarvish Steelclad) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Dwarvish Steelclad) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Steelclad) 4}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Steelclad) 5}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Dwarvish Thunderguard) 1}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Dwarvish Thunderguard) 1}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Thunderguard) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Thunderguard) 2}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Stalwart) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Stalwart) 2}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Lord) 1}
#endif

#ifdef HARD
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Dwarvish Steelclad) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Dwarvish Steelclad) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Steelclad) 5}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Steelclad) 6}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Dwarvish Thunderguard) 0}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Dwarvish Thunderguard) 1}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Thunderguard) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Thunderguard) 3}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Dwarvish Stalwart) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Stalwart) 3}

        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Dwarvish Lord) 2}
#endif

    {PICKUPPABLE_ITEM (poisoned_bow) (43) (35) (type=Elvish Fighter,Elvish Archer,Elvish Marksman,Elvish Sharpshooter,Elvish Ranger,Elvish Avenger,Elvish Hero,Elvish Champion) (items/bow.png)
        ( _"$unit.name finds a strange old bow. Should he pick it up?")
        ( _"poisoned_bow^Take it")
        ( _"poisoned_bow^Leave it")
        ( _"$unit.name finds strange old bow. But only a archer can take it!") (
        [object]
            name= _ "Poisoned Bow"
            image=attacks/bow-orcish.png
            duration=forever
            description= _ "This bow allows an archer to shoot poisoned arrows at his enemies!"
            [effect]
                apply_to=remove_attacks
                name=bow
            [/effect]
            [effect]
                apply_to=new_attack
                name=bow
                description= _ "poisonous bow"
                icon=attacks/bow-orcish.png
                type=pierce
                range=ranged
                damage=11
                number=3
                [specials]
                    {WEAPON_SPECIAL_POISON}
                [/specials]
            [/effect]
        [/object]
#        [unit_overlay]
#            x,y=$unit.x,$unit.y
#            image="icons/bow-icon.png"
#        [/unit_overlay]
        # v. 1.0.3          The unit is so proud and knows about its value for Quoscelia, and that for becomes loyal now
        # known problem: the loyal-trait overwrites the former first trait of the unit 
        [modify_unit]
            [filter]
                x,y=$unit.x,$unit.y
            [/filter]
            [modifications]
                [trait]
                    id=loyal
                    male_name= _ "loyal"
                    female_name= _ "female^loyal"
                    description= _ "Zero upkeep"
                    [effect]
                        apply_to=loyal
                    [/effect]
                [/trait]
            [/modifications]
            overlays="misc/loyal-icon.png", "icons/bow-icon.png"
        [/modify_unit]
        )}

    [story]
        [part]
            music="revelation.ogg"
            story= _ "The elves entered into the damp, dark, narrow passage with the trolls tagging along, often having to walk in single file past the narrowest sections. The occasional bat and giant spider were no match."
        [/part]
        [part]
            story= _ "The path came to an abrupt halt. The initial despair quickly subsided at the discovery of an ancient dwarvish teleportation rune. Seeing no other choice, they placed their trust in the artefact, which took them somewhere else in the darkness."
        [/part]
        [part]
            story= _ "Soon however, the elves once again found their path blocked, but not only by boulders."
        [/part]
        [part]
            background=bg_map.png
            show_title="yes"
        [/part]
    [/story]

    [event]
        name="prestart"

        [recall]
            id=Alvelyn
            x,y=44,2
        [/recall]
        [recall]
            id=Diludyren
            x,y=45,2
        [/recall]
        [unit]
            type="Troll Hero"
            id="Kruurg"
            name= _ "Kruurg"
            unrenamable=yes
            side="1"
            x="42"
            y="3"
            {IS_HERO}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        [unit]
#ifdef EASY
            type="Dwarvish Guardsman"
#endif
#ifdef NORMAL
            type="Dwarvish Guardsman"
#endif
#ifdef HARD
            type="Dwarvish Stalwart"
#endif
            id="Gu1"
            profile=portraits/dwarves/sentinel.png
            generate_name="yes"
            side="2"
            x="34"
            y="9"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [unit]
#ifdef EASY
            type="Dwarvish Guardsman"
#endif
#ifdef NORMAL
            type="Dwarvish Stalwart"
#endif
#ifdef HARD
            type="Dwarvish Stalwart"
#endif
            id="Gu2"
            image="units/dwarves/guard.png"
            generate_name="yes"
            side="2"
            x="39"
            y="11"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [unit]
            type="Dwarvish Stalwart"
            id="Gu3"
            image="units/dwarves/guard.png"
            generate_name="yes"
            side="2"
            x="38"
            y="11"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [unit]
            type="Giant Spider"
            id="Spider"
            name=""
            side="8"
            x="37"
            y="16"
            ai_special=guardian
#ifdef EASY
        [modifications]
            [object]
                silent=yes
                [effect]
                    apply_to=attack
                    range=melee
                    increase_damage=-8
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase_total=-25
                [/effect]
                [effect]
                    apply_to=movement
                    increase_total=-3
                [/effect]
            [/object]
        [/modifications]
#endif
#ifdef NORMAL
        [modifications]
            [object]
                silent=yes
                [effect]
                    apply_to=attack
                    range=melee
                    increase_damage=-4
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase_total=-20
                [/effect]
                [effect]
                    apply_to=movement
                    increase_total=-2
                [/effect]
            [/object]
        [/modifications]
#endif
#ifdef HARD
        [modifications]
            [object]
                silent=yes
                [effect]
                    apply_to=attack
                    range=melee
                    increase_damage=-2
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase_total=-15
                [/effect]
                [effect]
                    apply_to=movement
                    increase_total=-1
                [/effect]
            [/object]
        [/modifications]
#endif
        [/unit]

        [capture_village]
            x,y=25,8
            side=2
        [/capture_village]
        {VARIABLE paralyse_spider yes}
    [/event]

    [event]
        name=start
        [message]
            speaker=Quoscelia
            message= _ "A dead end! What will become of us now?!"
        [/message]
        [message]
            speaker=Alvelyn
            message= _ "Odd that the dwarves would build a teleportation rune to a dead end... hmm... that cave wall in front doesn't look too solid, looks more like the result of a cave-in. Looks like it can be busted down if enough force is applied to it."
        [/message]
        [delay]
            time=300
        [/delay]
        {MOVE_UNIT id=Kruurg  40 4}
        [redraw]
            side=1
        [/redraw]
        {BREAKTHROUGH 39 5}
        [message]
            speaker="Alvelyn"
            message= _ "Looks like this leads into a wide cave path oft used..."
        [/message]
        [redraw]
            side=1
        [/redraw]
        {MOVE_UNIT id=Kruurg     37 7}
        {MOVE_UNIT id=Quoscelia  36 6}
        [redraw]
            side=1
        [/redraw]
        {MOVE_UNIT id=Alvelyn    38 5}
        [redraw]
            side=1
        [/redraw]
        {MOVE_UNIT id=Diludyren  39 5}
        [redraw]
            side=1
        [/redraw]
        [delay]
            time=200
        [/delay]
        [message]
            speaker="Alvelyn"
            message= _ "Dwarves"
        [/message]
        [delay]
            time=150
        [/delay]
        [message]
            speaker="Gu1"
            message= _ "We're invaded"
        [/message]
        [message]
            speaker="Gu2"
            message= _ "<b>Alarm!</b>"
        [/message]
        {MOVE_UNIT id=Gu1 36 7}
        {FAKE_ATTACK_WITH_DAMAGE (Gu1) (Quoscelia) (spear) (staff) (0.85) (0.8)}
        {MOVE_UNIT id=Gu2 37 8}
        {FAKE_ATTACK_WITH_DAMAGE (Gu2) (Kruurg) (spear) (hammer) (0.55) (0.85)}
        [message]
            speaker="Gu3"
            message= _ "I warn our brothers ..."
        [/message]
        {MOVE_UNIT id=Gu3 23 9}
        [kill]
            id=Gu3
            animate=no
        [/kill]

        [objectives]
            side="1"
            silent="no"
            [objective]
                [show_if]
                    [have_unit]
                        id=Gu1,Gu2
                    [/have_unit]
                [/show_if]
                description= _ "Kill the guards"
                condition="win"
            [/objective]
            [objective]
                description= _ "Investigate the caverns"
                condition="win"
            [/objective]
            [objective]
                description= _ "Death of Quoscelia"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Alvelyn"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Diludyren"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Kruurg"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Time runs out"
                condition="lose"
            [/objective]
            [gold_carryover]
                bonus=yes
                carryover_percentage=30
            [/gold_carryover]
            [note]
               description= _ "Kruurg or any other Troll Hero, Troll Warrior or Great Troll can break 'weak' walls in this caves'"
                red=0
                green=0
                blue=255
            [/note]
        [/objectives]
    [/event]

    {ON_SIGHTING (spider) 1 side=8 (
        [if]
            [variable]
                name=unit.race
                equals=elf
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "A giant spider! I did not meant that there is such a thing truly!"
                [/message]
                [message]
                    speaker=unit
                    message= _ "It is realy enormous. And looks more dangerous than the bats..."
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.race
                equals=troll
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "Uh, a spider! $unit.name like spider. Hm yummy!"
                [/message]
            [/then]
        [/if]
        [scroll_to]
            x,y=$x2,$y2
        [/scroll_to]
        [delay]
            time=150
        [/delay]
        {VARIABLE_OP paralyse_spider value no}
    )}

    # This event prevents the spider from moving before it's sighted

    [event]
        name=turn refresh
        first_time_only=no

        [if]
            [variable]
                name=paralyse_spider
                equals=yes
            [/variable]

            [then]
                {MODIFY_UNIT (id=Spider) moves 0}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            race=elf
            [filter_location]
                x,y=36,1
                radius=2
            [/filter_location]
        [/filter]
        [message]
            speaker="unit"
            message= _ "Hmm, there's a plaque here: 'North to Main Cavern, South to Exit'."
        [/message]
        [message]
            speaker="Alvelyn"
            message= _ "Ha, seems we're not far. Now let's find that exit."
        [/message]
        [fire_event]
            name=update_objectives
        [/fire_event]
    [/event]

    [event]
        name=update_objectives
        first_time_only=yes
        [objectives]
            side="1"
            silent="no"
            [objective]
                description= _ "Move Quoscelia to the Southern Exit"
                condition="win"
            [/objective]
            [objective]
                description= _ "Death of Quoscelia"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Alvelyn"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Diludyren"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Kruurg"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Time runs out"
                condition="lose"
            [/objective]
            [gold_carryover]
                bonus=yes
                carryover_percentage=30
            [/gold_carryover]
            [note]
               description= _ "Kruurg or any other Troll Hero, Troll Warrior or Great Troll can break 'weak' walls in this caves'"
                red=0
                green=0
                blue=255
            [/note]
        [/objectives]
    [/event]

    [event]
        name=die
        [filter]
            id=Dwarfleader_1
        [/filter]
#ifdef EASY
        [unit]
            type="Dwarvish Ulfserker"
            id=cd1
            side="3"
            x="25"
            y="35"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Ulfserker"
            id=cd2
            side="3"
            x="25"
            y="34"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
#ifdef NORMAL
        [unit]
            type="Dwarvish Berserker"
            id=cd1
            side="3"
            x="25"
            y="35"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Ulfserker"
            id=cd2
            side="3"
            x="25"
            y="34"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
#ifdef HARD
        [unit]
            type="Dwarvish Berserker"
            id=cd1
            side="3"
            x="25"
            y="35"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Berserker"
            id=cd2
            side="3"
            x="25"
            y="34"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
        [fire_event]
            name=wake_up_side456
        [/fire_event]
    [/event]

    [event]
        name=wake_up_side456
        first_time_only=no
#ifdef EASY
        ### give gold to side 4
        [gold]
            side=4
            amount=30
        [/gold]
        ### give gold to side 5
        [gold]
            side=5
            amount=50
        [/gold]
        ### give gold to bats
        [gold]
            side=6
            amount=35
        [/gold]
#endif
#ifdef NORMAL
        ### give gold to side 4
        [gold]
            side=4
            amount=45
        [/gold]
        ### give gold to side 5
        [gold]
            side=5
            amount=55
        [/gold]
        ### give gold to bats
        [gold]
            side=6
            amount=40
        [/gold]
#endif
#ifdef HARD
        ### give gold to side 4
        [gold]
            side=4
            amount=60
        [/gold]
        ### give gold to side 5
        [gold]
            side=5
            amount=60
        [/gold]
        ### give gold to bats
        [gold]
            side=6
            amount=45
        [/gold]
#endif
    [/event]

    [event]
        name=die
        [filter]
            id=Dwarfleader_2
        [/filter]
#ifdef EASY
        [unit]
            type="Dwarvish Ulfserker"
            id=cd3
            side="4"
            x="18"
            y="46"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Ulfserker"
            id=cd4
            side="4"
            x="17"
            y="46"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
#ifdef NORMAL
        [unit]
            type="Dwarvish Berserker"
            id=cd3
            side="4"
            x="18"
            y="46"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Ulfserker"
            id=cd4
            side="4"
            x="17"
            y="46"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
#ifdef HARD
        [unit]
            type="Dwarvish Berserker"
            id=cd3
            side="4"
            x="18"
            y="46"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Berserker"
            id=cd4
            side="4"
            x="17"
            y="46"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
        [fire_event]
            name=wake_up_side456
        [/fire_event]
    [/event]

    [event]
        name=die
        [filter]
            id=Dwarfleader_3
        [/filter]
        [fire_event]
            name=gold_to_side56
        [/fire_event]
    [/event]

   # wake side 4 if the player uses the bypass and reaches the last dwarf before side 3 is defeated

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x="37"
                y="60"
                radius=9
            [/filter_location]
        [/filter]
        [fire_event]
            name=gold_to_side56
        [/fire_event]
    [/event]

    [event]
        name=gold_to_side56
        first_time_only=yes
#ifdef EASY
        ### give gold to side 5
        [gold]
            side=5
            amount=35
        [/gold]
        ### give income to side 5
        [modify_side]
            side=5
            income=8
        [/modify_side]
        ### give gold to side 6
        [gold]
            side=6
            amount=26
        [/gold]
#endif
#ifdef NORMAL
        ### give gold to side 5
        [gold]
            side=5
            amount=55
        [/gold]
        ### give income to side 5
        [modify_side]
            side=5
            income=10
        [/modify_side]
        ### give gold to side 6
        [gold]
            side=6
            amount=39
        [/gold]
#endif
#ifdef HARD
        ### give gold to side 5
        [gold]
            side=5
            amount=65
        [/gold]
        ### give income to side 5
        [modify_side]
            side=5
            income=12
        [/modify_side]
        ### give gold to side 6
        [gold]
            side=6
            amount=52
        [/gold]
#endif
    # create a last round of Ulfserkers/Berserkers
#ifdef EASY
        [unit]
            type="Dwarvish Ulfserker"
            id=cd5
            side="5"
            x="30"
            y="62"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Ulfserker"
            id=cd6
            side="5"
            x="31"
            y="62"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
#ifdef NORMAL
        [unit]
            type="Dwarvish Berserker"
            id=cd5
            side="5"
            x="30"
            y="62"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Ulfserker"
            id=cd6
            side="5"
            x="31"
            y="62"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
#ifdef HARD
        [unit]
            type="Dwarvish Berserker"
            id=cd5
            side="5"
            x="30"
            y="62"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
        [unit]
            type="Dwarvish Berserker"
            id=cd6
            side="5"
            x="31"
            y="62"
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]
#endif
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=13
            y=21
        [/filter]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The wall here does not look strong."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            type=Troll Hero, Great Troll, Troll Warrior
            x=13
            y=21
        [/filter]
        [unit]
            type="Red Mage"
            id="Aethelred"
            name= _ "Aethelred"
            side="7"
            x="9"
            y="20"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_QUICK}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        {KRUURG_CRUSHES_WALL 11 21}
        {MODIFY_UNIT (id=Aethelred) side 1}
        [delay]
            time=300
        [/delay]
        [message]
            speaker="Aethelred"
            message= _ "Who..."
        [/message]
        [message]
            speaker="Quoscelia"
            message= _ "The real question is, who are YOU, human?"
        [/message]
        [message]
            speaker="Aethelred"
            message= _ "I am Aethelred, a mage, and this is my hermitage. Two days ago, I think (since I can't see the sun), the entrance to the west of me had a massive cave-in, and I could do nothing but wait for my death. It is truly a miracle that I've been found, and I pledge my staff to your service."
        [/message]
        [message]
            speaker="Quoscelia"
            message= _ "Alright, human, you may come with us. (He looks powerful enough to be used for our purposes)"
        [/message]
        [message]
            speaker="Alvelyn"
            message= _ "Troll, can you break down the western exit this human speaks of?"
        [/message]
        [message]
            speaker="unit"
            message= _ "Wall too strong. $unit.name no break."
        [/message]
        [message]
            speaker="Alvelyn"
            message= _ "Sigh... looks like the southern exit is the only way."
        [/message]
        [fire_event]
            name=update_objectives
        [/fire_event]
    [/event]

        ### the by-pass

    [event]
        name=moveto
        [filter]
            side=1
            x=25
            y=16
        [/filter]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The wall here does not look strong."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            type=Troll Hero, Great Troll, Troll Warrior
            x=25
            y=16
        [/filter]
        {KRUURG_CRUSHES_WALL 26 16}
        [message]
            speaker="Alvelyn"
            message= _ "This leads to a an abandoned path leading straight south. It should take us faster to the exit."
        [/message]
        ### if the by-pass is chosen, then we wake up side 4, 5 and 6
        [fire_event]
            name=wake_up_side456
        [/fire_event]
        [fire_event]
            name=update_objectives
        [/fire_event]
    [/event]

        ### the by-pass exit

    [event]
        name=moveto             ### this triggers on both sides of this wall
        [filter]
            side=1
            x=26,24
            y=47,48
        [/filter]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The wall here does not look strong."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            type=Troll Hero, Great Troll, Troll Warrior
            x=26
            y=47
        [/filter]
        {KRUURG_CRUSHES_WALL 25 48}
    [/event]

    [event]
        name=moveto              ### the other side of the wall above
        [filter]
            type=Troll Hero, Great Troll, Troll Warrior
            x=24
            y=48
        [/filter]
        {KRUURG_CRUSHES_WALL 25 48}
        [message]
            speaker="Alvelyn"
            message= _ "Anybody in there?"
        [/message]
    [/event]

       ### the bat nest

    [event]
        name=moveto
        [filter]
            side=1
            x=33
            y=34
        [/filter]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The wall here does not look strong."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            type=Troll Hero, Great Troll, Troll Warrior
            x=33
            y=34
        [/filter]
        {UNIT 6 (Blood Bat) 38 34 ()}
        {UNIT 6 (Blood Bat) 39 35 ()}
        {UNIT 6 (Blood Bat) 41 34 ()}
        {UNIT 6 (Blood Bat) 42 37 ()}
#ifdef NORMAL
        {UNIT 6 (Blood Bat) 40 38 ()}
        {UNIT 6 (Blood Bat) 37 36 ()}
#endif
#ifdef HARD
        {UNIT 6 (Blood Bat) 40 38 ()}
        {UNIT 6 (Blood Bat) 39 38 ()}
        {UNIT 6 (Blood Bat) 38 37 ()}
        {UNIT 6 (Blood Bat) 37 36 ()}
#endif
        {KRUURG_CRUSHES_WALL 34 34}
        [remove_shroud]
            x,y=40,35
            radius=6
            side=1
        [/remove_shroud]
        [message]
            speaker="unit"
            message= _ "Bah! A nest of filthy bats!"
        [/message]
    [/event]


        ### the prisoners

    [event]
        name=moveto
        [filter]
            side=1
            x=9
            y=30
        [/filter]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The wall here does not look strong."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            type=Troll Hero, Great Troll, Troll Warrior
            x=9
            y=30
        [/filter]
        [unit]
            type="Thug"
            id="Nath"
            name= _ "Nath"
            side="7"
            x="6"
            y="28"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        [unit]
            type="Thug"
            id="Tramsley"
            name= _ "Tramsley"
            side="7"
            x="7"
            y="28"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        [unit]
            type="Ruffian"
            id="Fagin"
            name= _ "Fagin"
            side="7"
            x="8"
            y="28"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        {KRUURG_CRUSHES_WALL         8 29}
        {MODIFY_UNIT (id=Nath)     side 1}
        {MODIFY_UNIT (id=Tramsley) side 1}
        {MODIFY_UNIT (id=Fagin)    side 1}
        [message]
            speaker="Quoscelia"
            message= _ "Identify yourselves, humans!"
        [/message]
        [message]
            speaker="Nath"
            message= _ "I am Nath, and these two are my friends. Our little village was raided and we ran into these caves, but the dwarves took us prisoner and left us here to die."
        [/message]
        [message]
            speaker="Quoscelia"
            message= _ "You may join us against the dwarves. (these puny humans seem useful as fodder)"
        [/message]
        [message]
            speaker="Alvelyn"
            message= _ "(secretly) Seems there are human settlements nearby here..."
        [/message]
        [message]
            speaker="Quoscelia"
            message= _ "(acknowledges Alvelyn)"
        [/message]
        [message]
            speaker="Quoscelia"
            message= _ "Do you humans know where the exit to the cave is?"
        [/message]
        [message]
            speaker="Nath"
            message= _ "Yes, it's not far, though the path winds a bit to get to it."
        [/message]
        [remove_shroud]
            side=1
            x=10-19
            y=59-65
        [/remove_shroud]
        [scroll_to]
            x,y=15,62
        [/scroll_to]
        [delay]
            time=400
        [/delay]
        [scroll_to]
            x,y=8,29
        [/scroll_to]
        [fire_event]
            name=update_objectives
        [/fire_event]
    [/event]


        ### the chest

    {PLACE_IMAGE items/chest.png 19 2}

    [event]
        name=moveto
        [filter]
            x=19
            y=2
            side=1
        [/filter]
        [sound]
            name=gold.ogg
        [/sound]
        [store_gold]
            side=1
            variable=elfs_gold
        [/store_gold]
        [if]
            [variable]
                name=elfs_gold
                greater_than=180
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "You retrieve 79 pieces of gold!"
                [/message]
                [gold]
                    side=1
                    amount=79
                [/gold]
            [/then]
        [/if]
        [if]
            [variable]
                name=elfs_gold
                greater_than=90
            [/variable]
            [variable]
                name=elfs_gold
                less_than=181
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "You retrieve 129 pieces of gold!"
                [/message]
                [gold]
                    side=1
                    amount=129
                [/gold]
            [/then]
        [/if]
        [if]
            [variable]
                name=elfs_gold
                less_than=91
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "You retrieve 179 pieces of gold!"
                [/message]
                [gold]
                    side=1
                    amount=179
                [/gold]
            [/then]
        [/if]
        [gold]
            side=1
            amount=79
        [/gold]
        [remove_item]
            x=19
            y=2
        [/remove_item]
        {CLEAR_VARIABLE elfs_gold}
    [/event]

        ### the spiders treasure

    {PLACE_IMAGE items/gold-coins-medium.png 37 16}

    [event]
        name=moveto
        [filter]
            x=37
            y=16
            side=1
        [/filter]
        [message]
            speaker="unit"
            message= _ "Gold!"
        [/message]
        [sound]
            name=gold.ogg
        [/sound]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "You retrieve 147 pieces of gold!"
        [/message]
        [gold]
            side=1
            amount=147
        [/gold]
        [remove_item]
            x=37
            y=16
        [/remove_item]
    [/event]


        ### the exit

    [event]
        name=moveto
        [filter]
            x=0-17
            y=61-70
            id=Quoscelia
        [/filter]
        [message]
            speaker="Quoscelia"
            message= _ "Finally, sunlight again. Now let's get out and get our bearings."
        [/message]
        {CLEAR_VARIABLE paralyse_spider}
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 30}
        [/endlevel]
    [/event]

    [event]
        name=time over
        [message]
            speaker=Quoscelia
            message= _ "By now the dwarves have surely called in an army! We are doomed!"
        [/message]
    [/event]
    {~add-ons/A_Vision_Blinded/utils/deaths.cfg}
[/scenario]

#undef DWARF_AI
#undef BREAKTHROUGH
#undef KRUUG_CRUSHES_WALL X Y
#undef FAKE_ATTACK_WITH_DAMAGE ATTACKER DEFENDER ATTACK ATTACK2 M1 M2

